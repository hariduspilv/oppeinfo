<div class="ois-form-layout-padding ois-form-layout" ng-cloak>
  <form name="vocationalCurriculumModuleImplementationPlanForm" layout="column">
    <fieldset tabindex="1">
		<legend md-colors="{color: 'primary-800'}" class="md-title-small">{{'module.implementationPlan.subTitle' | translate}}</legend>
		<div layout="column">
			<md-input-container flex>
			  <label>{{'module.implementationPlan.codeOrName' | translate}}</label>
			  <input ng-model="implementationPlan.code" name="code" ng-model-options="{ debounce: 250 }" unique='codeUniqueQuery' type="text" md-maxlength="255" required ng-readonly="formState.readOnly">
				<div ng-messages="vocationalCurriculumModuleImplementationPlanForm.code.$error" ng-show="vocationalCurriculumModuleImplementationPlanForm.code.$dirty">
					<div ng-message="notUnique">
						{{'main.messages.error.mustBeUnique' | translate}}
					</div>
				</div>
			</md-input-container>
			<div layout="row">
				<md-input-container flex="45" flex-xs="100">
					  <label>{{'module.implementationPlan.studyForm' | translate}}</label>
					  <hois-classifier-select ng-model="implementationPlan.curriculumStudyForm" show-only-values="curriculumStudyForms"
					  model-value-attr="code" main-classifier-code="OPPEVORM" required ng-disabled="formState.readOnly"></hois-classifier-select>
				</md-input-container>
				<md-input-container flex="20" flex-offset="5">
					<label>{{'module.implementationPlan.admissionYear' | translate}}</label>
					<md-select ng-model="implementationPlan.admissionYear" ng-disabled="formState.readOnly">
					  <md-option ng-repeat="year in ::admissionYears" ng-value="year" aria-label="{{year}}">{{year}}</md-option>
					</md-select>
				 </md-input-container>
				  <md-input-container flex="25" flex-offset="5">
					<label>{{'module.implementationPlan.type' | translate}}</label>
					<hois-classifier-select ng-model="implementationPlan.type" model-value-attr="code" main-classifier-code="OPPEKAVA_VERSIOON_LIIK" required ng-disabled="formState.readOnly"></hois-classifier-select>
				  </md-input-container>
			</div>

			<md-input-container flex>
			  <label>{{'module.implementationPlan.targetGroup' | translate}}</label>
			  <input ng-model="implementationPlan.targetGroup" type="text" md-maxlength="1000" required ng-readonly="formState.readOnly">
			</md-input-container>

			<md-input-container flex>
			  <label>{{'module.implementationPlan.teachers' | translate}}</label>
			  <input ng-model="implementationPlan.teachers" type="text" md-maxlength="1000" required ng-readonly="formState.readOnly">
			</md-input-container>

			<md-input-container flex>
			  <label>{{'module.implementationPlan.teachingDepartment' | translate}}</label>
			  <hois-school-department-select ng-model="implementationPlan.schoolDepartment" required ng-disabled="formState.readOnly"></hois-school-department-select>
			</md-input-container>
			
			<md-input-container flex>
			  <label>{{'main.notes' | translate}}</label>
			  <textarea ng-model="implementationPlan.description" md-maxlength="20000" dfs max-rows="10" md-select-on-focus ng-readonly="formState.readOnly"></textarea>
			</md-input-container>

			<div layout="row" layout-xs="column">
				<md-input-container flex-xs="100">
				  <div layout="row" layout-align="end" flex>
					<md-checkbox ng-model="implementationPlan.individual" aria-label="individual" ng-disabled="formState.readOnly">{{'module.implementationPlan.individualCurriculum' | translate}}</md-checkbox>
				  </div>
				</md-input-container>
			</div>
		</div>
	</fieldset>	
	<div>&nbsp;</div>	
	<fieldset tabindex="2">
		<legend md-colors="{color: 'primary-800'}" class="md-title-small">{{'module.modules' | translate}}</legend>
		<div layout="row" flex class="secondary-table-header">
			<div flex="55">
			  {{'module.implementationPlan.moduleName' | translate}}
			</div>
			<div flex="30">
			  {{'module.implementationPlan.moduleCapacity' | translate}}
			</div>
			<div flex="15">
			  {{'module.implementationPlan.moduleOK' | translate}}
			</div>
		</div>
        <!-- OLD SOLUTION FOR DISPLAYING MODULES -->

		<!--<div ng-repeat="(moduleTypeCode, moduleTypeModules) in modulesWithOutOccupation track by moduleTypeCode" layout="column">
			<div class="occupation-header align-center">{{'module.modulesWithoutPartOccupationOccuaptionSpecialization' | translate}}</div>
			<div layout="row" ng-repeat="module in moduleTypeModules.modules track by $index" layout-sm="column" layout-align-sm="start start" layout-align="start center" flex class="secondary-table-row">
				<div flex="20">{{moduleTypeModules.moduleType[currentLanguageNameField()]}}</div>
				<div flex="35"><a style="margin-left:2em;" class="md-primary" ng-click="openViewModuleDialog(module)">{{module[currentLanguageNameField()]}}</a></div>
				<div flex="10">{{module.credits}} EKAP</div>
				<div flex="20">
				  <a class="md-primary" ng-click="openAddModuleDataDialog(module)" ng-if="!formState.readOnly || isOccupationModuleDataSaved(module)">
					{{isOccupationModuleDataSaved(module) ? 'module.implementationPlan.viewUpdateModuleData' : 'module.implementationPlan.insertModuleData' | translate}}
				  </a>
				</div>
				<div flex="15">
				  {{isOccupationModuleDataSaved(module) ? 'main.yes' : 'main.no' | translate}}
				</div>
			</div>
		</div>
		<div ng-repeat="(occupationCode, occupationModuleTypes) in occupationModuleTypesModules track by occupationCode " layout="column">
			<div class="occupation-header align-center">{{occupationModuleTypes.occupation[currentLanguageNameField()]}}</div>
            <div layout="column">
              <div ng-repeat="(moduleTypeCode, moduleTypeModules) in occupationModuleTypes.moduleTypes track by moduleTypeCode" layout="column">
                <div layout="column">
                  <div ng-repeat="module in moduleTypeModules.modules track by $index">
                    <div layout="row" layout-sm="column" layout-align-sm="start start" layout-align="start center" flex class="secondary-table-row">
                      <div flex="20">{{moduleTypeModules.moduleType[currentLanguageNameField()]}}</div>
					  <div flex="35">
                        <a class="md-primary" style="margin-left:2em;" ng-click="openViewModuleDialog(module)">
                          {{module[currentLanguageNameField()]}}
                        </a>
                      </div>
                      <div flex="10">
                        {{module.credits}} EKAP
                      </div>
                      <div flex="20">
                        <a class="md-primary" ng-click="openAddModuleDataDialog(module)" ng-if="!formState.readOnly || isOccupationModuleDataSaved(module)">
                          {{isOccupationModuleDataSaved(module) ? 'module.implementationPlan.viewUpdateModuleData' : 'module.implementationPlan.insertModuleData' | translate}}
                          </a>
                      </div>
                      <div flex="15">
                        {{isOccupationModuleDataSaved(module) ? 'main.yes' : 'main.no' | translate}}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </div>-->

            <!--MODULES WITHOUT OCCUPATIONS-->
            <div class="occupation-header align-center">{{'module.modulesWithoutPartOccupationOccuaptionSpecialization' | translate}}
            </div>
            <div layout="column" ng-repeat="type in moduleTypes | filter: filterTypesWithoutEmptyModules | orderBy: 'nameEt'">
                <div layout="row" flex="100" class="occupation-row align-center border-bottom odd">
                    <div flex="5">&nbsp;</div>
                    <div flex="15">{{currentLanguageNameField(type)}}</div>
                    <div layout="column" flex="75">
                        <div flex="100" ng-repeat="module in modules | filter: filterEmptyModulesByType(type.code) | orderBy: 'nameEt'" layout="row" class="align-center">
                            <a flex="50" ng-click="openViewModuleDialog(module)" href="">{{currentLanguageNameField(module)}}</a>
                            <span flex="15">{{module.credits}}&nbsp; EKAP</span>
                            <div flex="30">
                                <a class="md-primary" ng-click="openAddModuleDataDialog(module)" ng-if="!formState.readOnly || isOccupationModuleDataSaved(module)">
                                    {{isOccupationModuleDataSaved(module) ? 'module.implementationPlan.viewUpdateModuleData' : 'module.implementationPlan.insertModuleData' | translate}}
                                </a>
                            </div>
                            <div flex="15">
                                {{isOccupationModuleDataSaved(module) ? 'main.yes' : 'main.no' | translate}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>


             <!--KUTSETE/OSAKUTSETE MOODULID-->
            <div ng-repeat="occupation in occupations | orderBy: 'occupation.nameEt'" layout="column">
                <div class="occupation-header align-center">
                    <span ng-show="isOccupation">{{'stateCurriculum.enter.occupation.occupation' | translate}} {{$index + 1}}:&nbsp; {{currentLanguageNameField(occupation.occupation)}}</span>
                    <span ng-show="!isOccupation">{{'stateCurriculum.enter.occupation.partial' | translate}} {{$index + 1}}:&nbsp; {{currentLanguageNameField(occupation.occupation)}}</span>
                </div>
                <div layout="column" ng-repeat="type in moduleTypes | filter: filterTypesWithoutModules(occupation.occupation.code, modules) | orderBy: 'nameEt'">
                    <div layout="row" flex="100" class="occupation-row align-center border-bottom odd">
                        <div flex="5">&nbsp;</div>
                        <div flex="15">{{currentLanguageNameField(type)}}</div>
                        <div layout="column" flex="75">
                            <div flex="100" ng-repeat="module in modules | filter: filterModulesByType(type.code, occupation.occupation.code) | orderBy: 'nameEt'" layout="row" class="align-center">
                                <a flex="50" ng-click="openViewModuleDialog(module)" href="">{{currentLanguageNameField(module)}}</a>
                                <span flex="15">{{module.credits}}&nbsp; EKAP</span>
                                <div flex="30">
                                    <a class="md-primary" ng-click="openAddModuleDataDialog(module)" ng-if="!formState.readOnly || isOccupationModuleDataSaved(module)">
                                        {{isOccupationModuleDataSaved(module) ? 'module.implementationPlan.viewUpdateModuleData' : 'module.implementationPlan.insertModuleData' | translate}}
                                    </a>
                                </div>
                                <div flex="15">
                                    {{isOccupationModuleDataSaved(module) ? 'main.yes' : 'main.no' | translate}}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--OSAKUTSETE MOODULID-->
                <div ng-repeat = "partOccupation in occupation.partOccupations | orderBy: 'nameEt'" layout="column">
                    <div class="occupation-header2 align-center">{{'stateCurriculum.enter.occupation.partial' | translate}} {{$index + 1}}: {{currentLanguageNameField(partOccupation)}}</div>
                    <div layout="column" ng-repeat="type in moduleTypes | filter: filterTypesWithoutModules(partOccupation.code, modules) | orderBy: 'nameEt'">
                        <div layout="row" flex="100" class="occupation-row align-center border-bottom odd">
                            <div flex="5">&nbsp;</div>
                            <div flex="15">{{currentLanguageNameField(type)}}</div>
                            <div layout="column" flex="75">
                                <div flex="100" ng-repeat="module in modules | filter: filterModulesByType(type.code, partOccupation.code) | orderBy: 'nameEt'" layout="row" class="align-center">
                                    <a flex="50" ng-click="openViewModuleDialog(module)" href="">{{currentLanguageNameField(module)}}</a>
                                    <span flex="15">{{module.credits}}&nbsp; EKAP</span>
                                    <div flex="30">
                                        <a class="md-primary" ng-click="openAddModuleDataDialog(module)" ng-if="!formState.readOnly || isOccupationModuleDataSaved(module)">
                                            {{isOccupationModuleDataSaved(module) ? 'module.implementationPlan.viewUpdateModuleData' : 'module.implementationPlan.insertModuleData' | translate}}
                                        </a>
                                    </div>
                                    <div flex="15">
                                        {{isOccupationModuleDataSaved(module) ? 'main.yes' : 'main.no' | translate}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--SPETSKUTSETE MOODULID-->
                <div ng-repeat = "speciality in occupation.specialities | orderBy: 'nameEt'" layout="column">
                    <div class="occupation-header2 align-center">{{'stateCurriculum.enter.occupation.specialty' | translate}} {{$index + 1}}: &nbsp;
                        <hois-classifier-value ng-model="speciality" main-classifier-code="SPETSKUTSE"></hois-classifier-value>
                    </div>
                    <div layout="column" ng-repeat="type in moduleTypes | filter: filterTypesWithoutModules(speciality, modules) | orderBy: 'nameEt'">
                        <div layout="row" flex="100" class="occupation-row align-center border-bottom odd">
                            <div flex="5">&nbsp;</div>
                            <div flex="15">{{currentLanguageNameField(type)}}</div>
                            <div layout="column" flex="75">
                                <div flex="100" ng-repeat="module in modules | filter: filterModulesByType(type.code, speciality) | orderBy: 'nameEt'" layout="row" class="align-center">
                                    <a flex="50" ng-click="openViewModuleDialog(module)" href="">{{currentLanguageNameField(module)}}</a>
                                    <span flex="15">{{module.credits}}&nbsp; EKAP</span>
                                    <div flex="30">
                                        <a class="md-primary" ng-click="openAddModuleDataDialog(module)" ng-if="!formState.readOnly || isOccupationModuleDataSaved(module)">
                                            {{isOccupationModuleDataSaved(module) ? 'module.implementationPlan.viewUpdateModuleData' : 'module.implementationPlan.insertModuleData' | translate}}
                                        </a>
                                    </div>
                                    <div flex="15">
                                        {{isOccupationModuleDataSaved(module) ? 'main.yes' : 'main.no' | translate}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

	</fieldset>
	<div>&nbsp;</div>
	<fieldset tabindex="10">
		<legend md-colors="{color: 'primary-800'}" class="md-title-small">{{'curriculum.statuses' | translate}}</legend>
		<div layout="row" flex="100">		
		  <md-input-container flex="30" flex-sm="100" flex-xs="100">
			<label>{{'main.validFrom' | translate}}</label>
			<md-datepicker ng-model="implementationPlan.validFrom" md-open-on-focus required ng-disabled="formState.readOnly"></md-datepicker>
		  </md-input-container>

		  <md-input-container flex="20" flex-sm="100" flex-xs="100" flex-offset-xs="0" flex-offset-sm="0" flex-offset="4">
			<label>{{'main.validTo' | translate}}</label>
			<md-datepicker ng-model="implementationPlan.validThru" md-min-date="implementationPlan.validFrom" md-open-on-focus ng-disabled="formState.readOnly"></md-datepicker>
		  </md-input-container>
		</div>
		<div layout="row" class="top-margin form-readonly">
		  <md-input-container flex="30" flex-sm="100">
			<label>{{'main.status' | translate}}</label>
			<hois-classifier-value ng-model="currentStatus"  main-classifier-code="OPPEKAVA_VERSIOON_STAATUS"></hois-classifier-value>
		  </md-input-container>
      <!--<md-input-container ng-if="!formState.readOnly" flex-offset="4">
        <a href="" ng-show="implementationPlan.id > 0 && implementationPlan.status.code === 'OPPEKAVA_VERSIOON_STAATUS_M'" ng-click="implementationPlan.status = {code: 'OPPEKAVA_VERSIOON_STAATUS_K'}" class="md-primary">{{'main.button.status.confirm' | translate}}</a>
        <a href="" ng-show="implementationPlan.id > 0 && implementationPlan.status.code === 'OPPEKAVA_VERSIOON_STAATUS_S'" ng-click="implementationPlan.status = {code: 'OPPEKAVA_VERSIOON_STAATUS_M'}" class="md-primary">{{'main.button.status.approving' | translate}}</a>
        <a href="" ng-hide="!(implementationPlan.id > 0) || implementationPlan.status.code === 'OPPEKAVA_VERSIOON_STAATUS_C'" ng-click="implementationPlan.status = {code: 'OPPEKAVA_VERSIOON_STAATUS_C'}" class="md-primary">{{'main.button.status.close' | translate}}</a>
      </md-input-container>-->
    </div>
	</fieldset>
    

    

    <hois-created-modified object="implementationPlan"></hois-created-modified>
  </form>


  <!--<div layout="row">
    <md-button class="md-raised md-primary" ng-href="/#/vocationalCurriculum/{{curriculumId}}/edit/moduleImplementationPlan/{{implementationPlan.id}}/edit" ng-if="formState.readOnly">{{'main.button.change' | translate}}</md-button>
    <md-button class="md-raised md-primary" ng-click="save()" ng-if="!formState.readOnly">{{'main.button.save' | translate}}</md-button>
    <md-button class="md-raised md-default" ng-href="/#/vocationalCurriculum/{{curriculumId}}/edit" ng-if="!formState.readOnly">{{'main.button.back' | translate}}</md-button>
    <md-button class="md-raised md-default" ng-href="/#/vocationalCurriculum/{{curriculumId}}/view" ng-if="formState.readOnly">{{'main.button.back' | translate}}</md-button>
    <md-button ng-if="implementationPlan.id && !formState.readOnly" class="md-raised md-default" ng-click="copy()">{{'main.button.copy' | translate}}</md-button>
  </div>-->
      <div layout="row">
        <md-button class="md-raised md-primary" ng-click="goToEditForm()" ng-if="formState.readOnly && currentStatus !== VERSION_STATUS.C">{{'main.button.change' | translate}}</md-button>
        <md-button class="md-raised md-primary" ng-click="save()" ng-if="!formState.readOnly && currentStatus !== VERSION_STATUS.C">{{'main.button.save' | translate}}</md-button>

        <md-button ng-show="implementationPlan.id && currentStatus === VERSION_STATUS.S " ng-click="setStatusVerified()" class="md-raised">{{'curriculum.statuschange.implementationPlan.button.verify' | translate}}</md-button>
        <md-button ng-if="(currentStatus === VERSION_STATUS.S || currentStatus === VERSION_STATUS.K) && implementationPlan.id" ng-click="setStatusClosed()" class="md-raised">{{'curriculum.statuschange.implementationPlan.button.close' | translate}}</md-button>

        <md-button class="md-raised md-default" ng-click="copy()" ng-if="implementationPlan.id">{{'main.button.copy' | translate}}</md-button>
        <md-button class="md-raised md-default" ng-click="delete()" ng-if="implementationPlan.id && currentStatus === VERSION_STATUS.S && !formState.readOnly">{{'main.button.delete' | translate}}</md-button>
        <md-button class="md-raised md-default" ng-click="back('/#/vocationalCurriculum/' + curriculumId + '/edit', vocationalCurriculumModuleImplementationPlanForm)">{{'main.button.back' | translate}}</md-button>
    </div>
</div>
