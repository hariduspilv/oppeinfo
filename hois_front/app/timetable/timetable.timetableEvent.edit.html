
<div class="ois-form-layout-padding" ng-cloak>
  <div flex>
    <form name="eventForm" ng-submit="eventForm.$valid && loadData()" novalidate layout="column">
      <div layout="row" flex="100">
        <md-input-container flex="50" flex-sm="100">
          <label>{{'main.date' | translate}}</label>
          <md-datepicker required ng-model="timetableEvent.date"></md-datepicker>
        </md-input-container>
        <md-input-container flex flex-sm="100" flex-offset="2" flex-offset-xs="0" flex-offset-sm="0">
          <label>{{'main.start' | translate}}</label>
          <hois-time required ng-model="timetableEvent.startTime" placeholder="{{'main.timePlaceholder' | translate}}"></hois-time>
        </md-input-container>
        <md-input-container flex flex-sm="100" flex-offset="2" flex-offset-xs="0" flex-offset-sm="0">
          <label>{{'main.end' | translate}}</label>
          <hois-time required ng-model="timetableEvent.endTime" placeholder="{{'main.timePlaceholder' | translate}}"></hois-time>
        </md-input-container>
      </div>
      <md-input-container flex>
        <label class="textInput">{{'timetable.timetableEvent.name' | translate}}</label>
        <input type="text" ng-model="timetableEvent.name" required md-maxlength="255">
      </md-input-container>
      <div ng-if="!timetableEvent.id" layout="row" flex="100">
        <md-input-container flex="20" flex-sm="100" flex-xs="100">
          <md-checkbox ng-model="timetableEvent.repeat" aria-label="Is repeat event">
            {{'timetable.timetableEvent.isRepeat' | translate}}
          </md-checkbox>
        </md-input-container>
        <div ng-if="timetableEvent.repeat" flex="80">
          <md-input-container flex="50">
            <label>{{'timetable.timetableEvent.weekAmount' | translate}}</label>
            <input flex="100" ng-model="timetableEvent.weekAmount" type="number" autofocus aria-label="weekamount" required>
          </md-input-container>

          <md-input-container flex="50" flex-offset="5">
            <label>{{'timetable.timetableEvent.repetition' | translate}}</label>
            <hois-classifier-select flex="100" ng-model="timetableEvent.repeatCode" model-value-attr="code" aria-label="repeatcode" 
              filter-values="['TUNNIPLAAN_SYNDMUS_KORDUS_EI']" main-classifier-code="TUNNIPLAAN_SYNDMUS_KORDUS" required>
            </hois-classifier-select>
          </md-input-container>
        </div>
      </div>

      <div layout="row" flex="60" flex-sm="100" flex-xs="100">
        <hois-autocomplete label="{{auth.higher ? 'timetable.timetableEvent.teacherHigher' : 'timetable.timetableEvent.teacherVocational'}}" 
          ng-model="timetableEvent.teacher" ng-disabled="auth.isTeacher()" method="teachers" warning-param="isOccupied"
          additional-query-params="{valid: true, occupied: true, date: timetableEvent.date, startTime: timetableEvent.startTime, endTime: timetableEvent.endTime, 
            repeatCode: timetableEvent.repeatCode, weekAmount: timetableEvent.weekAmount}" flex></hois-autocomplete>
      </div>
      <md-table-container ng-if="timetableEvent.teachers.length > 0" layout="row" layout="row" flex="60" flex-sm="100" flex-xs="100">
        <table md-table class="secondary-table">
          <thead md-head>
            <tr md-row>
              <th md-column ng-style="{'width': !timetableEvent.isSingleEvent ? 70 + '%' : 90 + '%' }">{{'timetable.timetableEvent.teacherName' | translate}}</th>
              <th md-column ng-if="!timetableEvent.isSingleEvent" width="20%">{{'timetable.timetableEvent.substitute' | translate}}</th>
              <th md-column width="10%"></th>
            </tr>
          </thead>
          <tbody md-body>
            <tr md-row ng-repeat="teacher in timetableEvent.teachers | orderBy: sortTeachers" ng-class-odd="'odd'" ng-class-even="'even'">
              <td md-cell>{{currentLanguageNameField(teacher.teacher)}}</td>
              <td md-cell ng-if="!timetableEvent.isSingleEvent">
                <md-checkbox ng-model="teacher.isSubstitute" aria-label="{{'timetable.timetableEvent.substitute' | translate}}" ng-disabled="!auth.isAdmin()"></md-checkbox>
              </td>
              <td md-cell>
                <a ng-if="auth.isAdmin()" ng-click="deleteTeacher(teacher)" class="remove">&times;</a>
              </td>
            </tr>
          </tbody>
        </table>
      </md-table-container>

      <div layout="row" flex="60" flex-sm="100" flex-xs="100">
        <hois-autocomplete label="timetable.timetableEvent.room" ng-model="timetableEvent.room" method="rooms" warning-param="isOccupied"
          additional-query-params="{isStudy: true, occupied: true, date: timetableEvent.date, startTime: timetableEvent.startTime, endTime: timetableEvent.endTime, 
            repeatCode: timetableEvent.repeatCode, weekAmount: timetableEvent.weekAmount}" flex></hois-autocomplete>
      </div>
      <md-table-container ng-if="timetableEvent.rooms.length > 0" layout="row" flex="60" flex-sm="100" flex-xs="100">
        <table md-table class="secondary-table">
          <thead md-head>
            <tr md-row>
              <th md-column width="90%">{{'timetable.timetableEvent.code' | translate}}</th>
              <th md-column width="10%"></th>
            </tr>
          </thead>
          <tbody md-body>
            <tr md-row ng-repeat="room in timetableEvent.rooms | orderBy: currentLanguageNameField()" ng-class-odd="'odd'" ng-class-even="'even'">
              <td md-cell>{{room.nameEt}}</td>
              <td md-cell>
                <a ng-click="deleteRoom(room)" class="remove">&times;</a>
              </td>
            </tr>
          </tbody>
        </table>
      </md-table-container>

      <div layout="row" flex="60" flex-sm="100" flex-xs="100">
        <hois-autocomplete label="timetable.timetableEvent.studentGroup" ng-model="timetableEvent.studentGroup" method="studentgroups" warning-param="isOccupied"
          additional-query-params="{valid: true, occupied: true, date: timetableEvent.date, startTime: timetableEvent.startTime, endTime: timetableEvent.endTime, 
            repeatCode: timetableEvent.repeatCode, weekAmount: timetableEvent.weekAmount, studentGroupTeacherId: auth.isTeacher() ? auth.teacher : undefined}" 
          flex></hois-autocomplete>
      </div>
      <md-table-container ng-if="timetableEvent.studentGroups.length > 0" layout="row" flex="60" flex-sm="100" flex-xs="100">
        <table md-table class="secondary-table">
          <thead md-head>
            <tr md-row>
              <th md-column width="90%">{{'timetable.timetableEvent.code' | translate}}</th>
              <th md-column width="10%"></th>
            </tr>
          </thead>
          <tbody md-body>
            <tr md-row ng-repeat="studentGroup in timetableEvent.studentGroups" ng-class-odd="'odd'" ng-class-even="'even'">
              <td md-cell>{{studentGroup.nameEt}}</td>
              <td md-cell>
                <a ng-click="deleteStudentGroup(studentGroup)" class="remove">&times;</a>
              </td>
            </tr>
          </tbody>
        </table>
      </md-table-container>

      <md-input-container flex>
        <label class="textInput">
          {{auth.higher ? ('timetable.timetableEvent.otherTeacherHigher' | translate) : ('timetable.timetableEvent.otherTeacherVocational' | translate)}}
        </label>
        <input type="text" ng-model="timetableEvent.otherTeacher" md-maxlength="1000">
      </md-input-container>
      <md-input-container flex>
        <label class="textInput">{{'timetable.timetableEvent.otherRoom' | translate}}</label>
        <input type="text" ng-model="timetableEvent.otherRoom" md-maxlength="1000">
      </md-input-container>

      <div layout="row" flex>
        <md-button class="md-raised md-primary" ng-click="save()">{{'main.button.save' | translate}}</md-button>
        <md-button ng-if="timetableEvent.id" ng-click="delete()" class="md-raised">{{'main.button.delete' | translate}}</md-button>
        <md-button ng-click="back('#/lessonplans/events', eventForm)" class="md-raised">{{'main.button.back' | translate}}</md-button>
      </div>
    </form>
  </div>
</div>
