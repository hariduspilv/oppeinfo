<div class="ois-form-layout" layout="column" layout-margin ng-cloak ng-show="!showMainForm">
  <form name="higherCurriculumVersionForm" layout="column">
    <fieldset tabindex="1">
      <legend md-colors="{color: 'primary-800'}" class="md-title-small">{{'curriculum.versionMainData' | translate}}</legend>
      <div layout="column">
        <md-input-container flex ng-if="!showMainForm">
          <label>{{'curriculum.version.code' | translate}}</label>
          <input name="code" ng-model="version.code" type="text" required md-maxlength="100" ng-model-options="{ debounce: 250 }"
            unique="curriculumVersionCodeUniqueQuery" ng-readonly="formState.readOnly">
          <div ng-messages="higherCurriculumVersionForm.code.$error">
            <div ng-message="notUnique">
              {{'main.messages.error.mustBeUnique' | translate}}
            </div>
          </div>
        </md-input-container>
        <div layout="row" flex>
          <md-input-container flex="45">
            <label>{{'curriculum.version.firstAdmissionYear' | translate}}</label>
            <md-select ng-model="version.admissionYear" required ng-disabled="formState.readOnly">
              <md-option ng-repeat="year in ::admissionYears" ng-value="year" aria-label="{{year}}">{{year}}</md-option>
            </md-select>
          </md-input-container>
          <md-input-container flex="50" flex-offset="5">
            <label>{{'curriculum.version.type' | translate}}</label>
            <hois-classifier-select ng-model="version.type" main-classifier-code="OPPEKAVA_VERSIOON_LIIK" required model-value-attr="code"
              ng-disabled="formState.readOnly"></hois-classifier-select>
          </md-input-container>
        </div>
        <div layout="row" layout-sm="column" layout-xs="column">
          <md-input-container flex="45" flex-sm="100" flex-xs="100">
            <label>{{'curriculum.specialty.specialties' | translate}}</label>
            <md-select multiple ng-model="version.specialitiesReferenceNumbers" required ng-change="removeSpecsFromModules()" ng-disabled="formState.readOnly">
              <md-option ng-repeat="speciality in curriculum.specialities | orderBy: currentLanguageNameField()" ng-value="speciality.referenceNumber">
                {{speciality[currentLanguageNameField()]}}
              </md-option>
            </md-select>
          </md-input-container>
          <div flex="50" flex-offset="5" ng-show="!formState.readOnly" layout="start center">
            <md-button class="md-raised" ng-click="openAddSpecialtyDialog()">{{'curriculum.specialty.addNew' | translate}}</md-button>
          </div>
        </div>
        <br>
      </div>
    </fieldset>
    <div>&nbsp;</div>
    <fieldset tabindex="2" flex>
      <legend md-colors="{color: 'primary-800'}" class="md-title-small" ng-class="{invalid: higherCurriculumVersionForm.$submitted && strictValidation() && !allSpecialitiesValid()}">{{'module.modules' | translate}}&nbsp;*</legend>
      <md-button class="md-raised" ng-click="openAddModuleDialog()" ng-if="!formState.readOnly && version.specialitiesReferenceNumbers.length > 0">{{'module.add' | translate}}</md-button>

      <div ng-repeat="spectiality in curriculum.specialities | filter: filterSpecialities | orderBy: currentLanguageNameField()"
        layout="column" flex>
        <h2 class="md-title-small" ng-class="{invalid: higherCurriculumVersionForm.$submitted && strictValidation() && !specialityValid(spectiality.id)}">{{'curriculum.specialty.specialty' | translate}} {{$index + 1}}: {{currentLanguageNameField(spectiality)}}</h2>
        <div flex class="secondary-table-header" layout="row">
          <div flex="5">&nbsp;</div>
          <div flex="35">{{'subject.name' | translate}}</div>
          <div flex="10">{{'subject.code' | translate}}</div>
          <div flex="20">EAP</div>
          <div></div>
        </div>

        <div layout="column" flex ng-repeat="module in version.modules | filter: {minorSpeciality: false} | filter: filterModulesBySpeciality(spectiality) | orderBy: currentLanguageNameField()">
          <div layout="row" flex class="occupation-header" layout-align="start center">
            <a href="" ng-click="openAddModuleDialog(module)" flex="70" ng-class="{invalid: higherCurriculumVersionForm.$submitted && !moduleHasSubjects(module) && strictValidation()}">
                                {{'curriculum.module' | translate}} {{module[currentLanguageNameField()]}} {{module.totalCredits}} EAP
                                <!--<span ng-if="module.type !== 'KORGMOODUL_M'">(<hois-classifier-value ng-model="module.type" main-classifier-code="KORGMOODUL"></hois-classifier-value>)</span>-->
                                <span ng-if="module.type === 'KORGMOODUL_M'">({{currentLanguage()=='et' ? module.typeNameEt : module.typeNameEn}})</span>
                            </a>
            <!--<a class="remove nomargin" ng-click="removeModuleFromSpeciality(module, spectiality)" ng-if="!formState.readOnly">&times;</a>-->
          </div>

          <div flex class="sub-header1" layout-align="start center" layout="row">
            <div>{{'subject.mandatory' | translate}}</div>
          </div>
          <div ng-repeat="subject in module.subjects | filter: {optional: false} | orderBy: currentLanguageNameField()" layout="row"
            flex class="secondary-table-row" layout-align="start center">
            <div flex="5">&nbsp;</div>
            <div flex="35">{{subject[currentLanguageNameField()]}}</div>
            <div flex="10">{{subject.code}}</div>
            <div flex="20">{{subject.credits}}</div>
            <div>
              <a class="remove nomargin" ng-click="deleteSubject(module, subject)" ng-if="!formState.readOnly">&times;</a>
            </div>
          </div>

          <div layout="row" flex layout-align="start center" class="secondary-table-header">
            <div flex="5">&nbsp;</div>
            <div flex="35">{{'main.OF' | translate}}</div>
            <div flex="10">&nbsp;</div>
            <div flex="20">{{module.compulsoryStudyCredits}}</div>
            <div></div>
          </div>

          <div flex class="sub-header1" layout-align="start center" layout="row">
            <div>{{'subject.optional' | translate}}</div>
          </div>
          <div ng-repeat="subject in module.subjects |
                        filter: {optional: true} | filter: {electiveModule: '!'} | orderBy: currentLanguageNameField()"
            layout="row" flex class="secondary-table-row" layout-align="start center">
            <div flex="5">&nbsp;</div>
            <div flex="35">{{subject[currentLanguageNameField()]}}</div>
            <div flex="10">{{subject.code}}</div>
            <div flex="20">{{subject.credits}}</div>
            <div>
              <a class="remove nomargin" ng-click="deleteSubject(module, subject)" ng-if="!formState.readOnly">&times;</a>
            </div>
          </div>

          <div flex class="sub-header-italic" layout-align="start center" layout="row" style="padding-left: 10px">
            <div>{{'module.optionalsWithMinimum' | translate}}{{module.electiveModulesNumber}}</div>
          </div>
          <div ng-repeat="electiveModule in module.electiveModules | orderBy: currentLanguageNameField()" layout-align="start center"
            flex>
            <div class="sub-header2" layout-align="start center" layout="row">
              <div>{{'module.optional' | translate}}: {{electiveModule[currentLanguageNameField()]}}</div>
            </div>
            <div ng-repeat="subject in module.subjects | filter: {optional: true} |
                                filter: {electiveModule: electiveModule.referenceNumber} | orderBy: currentLanguageNameField()"
              layout="row" flex class="secondary-table-row" layout-align="start center">
              <div flex="5">&nbsp;</div>
              <div flex="35">{{subject[currentLanguageNameField()]}}</div>
              <div flex="10">{{subject.code}}</div>
              <div flex="20">{{subject.credits}}</div>
              <div>
                <a class="remove nomargin" ng-click="deleteSubject(module, subject)" ng-if="!formState.readOnly">&times;</a>
              </div>
            </div>
          </div>
          <div layout="row" flex layout-align="start center" class="secondary-table-header">
            <div flex="5">&nbsp;</div>
            <div flex="35">{{'module.overallAtLeast' | translate}}</div>
            <div flex="10">&nbsp;</div>
            <div flex="20">{{module.optionalStudyCredits}}</div>
            <div></div>
          </div>
        </div>

        <!--Show modules by specialities-->

      </div>
    </fieldset>
    <div>&nbsp;</div>
    <fieldset tabindex="3">
      <legend md-colors="{color: 'primary-800'}" class="md-title-small" ng-class="{invalid: higherCurriculumVersionForm.$submitted && !allMinorSpecialitiesValid()}">{{'curriculum.minorSpecialty.minorSpecialties' | translate}}</legend>
      <md-button class="md-raised" ng-click="openAddMinorSpecialtyDialog()" ng-if="!formState.readOnly">{{'curriculum.minorSpecialty.add' | translate}}</md-button>

      <div layout="column" flex ng-repeat="module in version.modules | filter: {minorSpeciality: true} | orderBy: currentLanguageNameField()">
        <div layout="row" flex class="occupation-header" layout-align="start center">
          <a href="" ng-click="openAddMinorSpecialtyDialog(module)" flex="70" ng-class="{invalid: higherCurriculumVersionForm.$submitted && !moduleHasSubjects(module) && strictValidation()}">
                                <span>{{'curriculum.minorSpecialty.minorSpecialty' | translate}} {{module[currentLanguageNameField()]}} {{module.totalCredits}} EAP</span>
                     </a>
          <!--<a class="remove nomargin" ng-click="removeModule(version.modules, module)" ng-if="!formState.readOnly">&times;</a>-->
        </div>

        <div flex class="sub-header1" layout-align="start center" layout="row">
          <div>{{'subject.mandatory' | translate}}</div>
        </div>
        <div ng-repeat="subject in module.subjects | filter: {optional: false} | orderBy: currentLanguageNameField()" layout="row"
          flex class="secondary-table-row" layout-align="start center">
          <div flex="5">&nbsp;</div>
          <div flex="35">{{subject[currentLanguageNameField()]}}</div>
          <div flex="10">{{subject.code}}</div>
          <div flex="20">{{subject.credits}}</div>
          <div>
            <a class="remove nomargin" ng-click="deleteSubject(module, subject)" ng-if="!formState.readOnly">&times;</a>
          </div>
        </div>

        <div layout="row" flex layout-align="start center" class="secondary-table-header">
          <div flex="5">&nbsp;</div>
          <div flex="35">{{'main.OF' | translate}}</div>
          <div flex="10">&nbsp;</div>
          <div flex="20">{{module.compulsoryStudyCredits}}</div>
          <div></div>
        </div>

        <div flex class="sub-header1" layout-align="start center" layout="row">
          <div>{{'subject.optional' | translate}}</div>
        </div>
        <div ng-repeat="subject in module.subjects |
                        filter: {optional: true} | filter: {electiveModule: '!'} | orderBy: currentLanguageNameField()"
          layout="row" flex class="secondary-table-row" layout-align="start center">
          <div flex="5">&nbsp;</div>
          <div flex="35">{{subject[currentLanguageNameField()]}}</div>
          <div flex="10">{{subject.code}}</div>
          <div flex="20">{{subject.credits}}</div>
          <div>
            <a class="remove nomargin" ng-click="deleteSubject(module, subject)" ng-if="!formState.readOnly">&times;</a>
          </div>
        </div>
        <div flex class="sub-header-italic" layout-align="start center" layout="row" style="padding-left: 10px">
          <div>{{'module.optionalsWithMinimum' | translate}}{{module.electiveModulesNumber}}</div>
        </div>
        <div ng-repeat="electiveModule in module.electiveModules | orderBy: currentLanguageNameField()" layout-align="start center"
          flex>
          <div class="sub-header2" layout-align="start center" layout="row">
            <div>{{'module.optional' | translate}}: {{electiveModule[currentLanguageNameField()]}}</div>
          </div>
          <div ng-repeat="subject in module.subjects | filter: {optional: true} |
                                filter: {electiveModule: electiveModule.referenceNumber} | orderBy: currentLanguageNameField()"
            layout="row" flex class="secondary-table-row" layout-align="start center">
            <div flex="5">&nbsp;</div>
            <div flex="35">{{subject[currentLanguageNameField()]}}</div>
            <div flex="10">{{subject.code}}</div>
            <div flex="20">{{subject.credits}}</div>
            <div>
              <a class="remove nomargin" ng-click="deleteSubject(module, subject)" ng-if="!formState.readOnly">&times;</a>
            </div>
          </div>
        </div>
        <div layout="row" flex layout-align="start center" class="secondary-table-header">
          <div flex="5">&nbsp;</div>
          <div flex="35">{{'module.overallAtLeast' | translate}}</div>
          <div flex="10">&nbsp;</div>
          <div flex="20">{{module.optionalStudyCredits}}</div>
          <div></div>
        </div>
      </div>
    </fieldset>
    <div>&nbsp;</div>
    <fieldset tabindex="4">
      <legend md-colors="{color: 'primary-800'}" class="md-title-small">{{'curriculum.versionStatus' | translate}}</legend>
      <div layout="row" flex="100">
        <md-input-container flex="30" flex-sm="100" flex-xs="100">
          <label>{{'main.validFrom' | translate}}</label>
          <md-datepicker ng-model="version.validFrom" md-open-on-focus required ng-disabled="formState.readOnly"></md-datepicker>
        </md-input-container>

        <md-input-container flex="20" flex-sm="100" flex-xs="100" flex-offset-xs="0" flex-offset-sm="0" flex-offset="4">
          <label>{{'main.validTo' | translate}}</label>
          <md-datepicker ng-model="version.validThru" md-min-date="version.validFrom" md-open-on-focus ng-disabled="formState.readOnly"></md-datepicker>
        </md-input-container>
      </div>
      <div layout="row" class="top-margin form-readonly">
        <md-input-container flex="30" flex-sm="100">
          <label>{{'main.status' | translate}}</label>
          <hois-classifier-value ng-model="currentStatus" main-classifier-code="OPPEKAVA_VERSIOON_STAATUS"></hois-classifier-value>
        </md-input-container>
      </div>
    </fieldset>
    <hois-created-modified object="version"></hois-created-modified>
  </form>

  <div layout="row">
    <div ng-show="currentStatus === VERSION_STATUS.S">
      <div ng-show="!version.id">
        <md-button class="md-raised md-primary" ng-click="save()">{{'main.button.save' | translate}}</md-button>
      </div>
      <div ng-show="!formState.readOnly && version.id">
        <md-button class="md-raised md-primary" ng-click="save()">{{'main.button.save' | translate}}</md-button>
        <md-button ng-click="setStatusVerified()" class="md-raised">{{'curriculum.statuschange.version.button.verify' | translate}}</md-button>
        <md-button ng-click="setStatusClosed()" class="md-raised">{{'curriculum.statuschange.version.button.close' | translate}}</md-button>
        <md-button class="md-raised md-default" ng-click="copy()">{{'main.button.copy' | translate}}</md-button>
        <md-button class="md-raised md-default" ng-click="delete()">{{'main.button.delete' | translate}}</md-button>
      </div>
      <div ng-show="formState.readOnly">
        <md-button class="md-raised md-primary" ng-click="goToEditForm()">{{'main.button.change' | translate}}</md-button>
        <md-button ng-click="setStatusVerified()" class="md-raised">{{'curriculum.statuschange.version.button.verify' | translate}}</md-button>
        <md-button ng-click="setStatusClosed()" class="md-raised">{{'curriculum.statuschange.version.button.close' | translate}}</md-button>
        <md-button class="md-raised md-default" ng-click="copy()">{{'main.button.copy' | translate}}</md-button>
      </div>
    </div>
    <div ng-show="currentStatus === VERSION_STATUS.K">
      <div ng-show="!formState.readOnly">
        <md-button class="md-raised md-primary" ng-click="save()">{{'main.button.save' | translate}}</md-button>
      </div>
      <div ng-show="formState.readOnly">
        <md-button class="md-raised md-primary" ng-click="goToEditForm()">{{'main.button.change' | translate}}</md-button>
        <md-button ng-click="setStatusClosed()" class="md-raised">{{'curriculum.statuschange.version.button.close' | translate}}</md-button>
        <md-button class="md-raised md-default" ng-click="copy()">{{'main.button.copy' | translate}}</md-button>
      </div>
    </div>
    <div ng-show="currentStatus === VERSION_STATUS.C">
      <md-button class="md-raised md-default" ng-click="copy()">{{'main.button.copy' | translate}}</md-button>
    </div>

    <md-button class="md-raised md-default" ng-click="back('#/higherCurriculum/' + version.curriculum + '/view')">{{'main.button.back' | translate}}</md-button>
  </div>
</div>
